<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Celis Sketchpad | V46 Junta</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a202c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #2d3748; color: white; margin: 0; overflow: hidden; touch-action: none; }
        #main-app { display: none; height: 100vh; flex-direction: column; }
        #canvas-container { position: relative; flex-grow: 1; background-color: #333; }
        .notebook-style {
            background-color: #fdf6e3 !important;
            background-image: linear-gradient(#e2e2e2 1px, transparent 1px), linear-gradient(90deg, transparent 40px, #d42a2a 40px, #d42a2a 42px, transparent 42px) !important;
            background-size: 100% 30px !important;
        }
        #pizarra { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; }
        .top-bar { height: 60px; background: #1a202c; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 20; }
        .bottom-bar { height: 85px; background: #1a202c; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; border-top: 1px solid #4a5568; z-index: 20; }
        .tool-btn { width: 45px; height: 45px; border-radius: 8px; background: #2d3748; display: inline-flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #a0aec0; flex-shrink: 0; margin: 0 4px; border: 1px solid #4a5568; }
        .tool-btn.active { background: #00E5FF; color: #000; border-color: #00E5FF; }
        .magic-active { background: #764ba2; color: white; border-color: white; }
    </style>
</head>
<body>

    <div id="modeOverlay" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-[100]">
        <h2 class="text-3xl font-bold mb-10 text-cyan-400">CELIS SKETCH</h2>
        <div class="flex gap-6">
            <button onclick="initApp('paper')" class="w-32 h-32 bg-[#fdf6e3] text-black rounded-2xl font-bold border-4 border-red-600">HOJA</button>
            <button onclick="initApp('photo')" class="w-32 h-32 bg-cyan-500 text-black rounded-2xl font-bold border-4 border-white">FOTO</button>
        </div>
    </div>

    <div id="main-app">
        <div class="top-bar">
            <button onclick="location.reload()" class="text-gray-400"><i class="fas fa-home text-xl"></i></button>
            <div class="flex gap-3">
                <button onclick="deshacer()" class="text-gray-300 px-2"><i class="fas fa-undo text-xl"></i></button>
                <button onclick="borrarLienzoSmart()" class="text-red-500 px-2"><i class="fas fa-trash text-xl"></i></button>
                <button onclick="generarPDFTaller()" class="bg-white text-black px-4 py-1 rounded font-bold text-sm">TALLER</button>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="pizarra"></canvas>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="cargarImagen(this)">
        </div>

        <div class="bottom-bar">
            <button onclick="toggleMagic()" id="btnMagic" class="tool-btn"><i class="fas fa-magic"></i></button>
            <button onclick="setTool('eraser', this)" class="tool-btn text-pink-400"><i class="fas fa-eraser"></i></button>
            <button onclick="setTool('free', this)" class="tool-btn active"><i class="fas fa-pen"></i></button>
            <button onclick="setTool('arc', this)" class="tool-btn text-white"><i class="fas fa-bezier-curve"></i></button>
            <button onclick="setTool('rect', this)" class="tool-btn"><i class="far fa-square"></i></button>
            <button onclick="setTool('circle', this)" class="tool-btn"><i class="far fa-circle"></i></button>
            <button onclick="setTool('text', this)" class="tool-btn font-bold">T</button>
            <div class="w-px h-8 bg-gray-600 mx-2"></div>
            <button onclick="setColor('#00E5FF', this)" class="tool-btn" style="color:#00E5FF"><i class="fas fa-circle"></i></button>
            <button onclick="setColor('#FF4444', this)" class="tool-btn" style="color:#FF4444"><i class="fas fa-circle"></i></button>
            <button onclick="setColor('#FFFF00', this)" class="tool-btn" style="color:#FFFF00"><i class="fas fa-circle"></i></button>
            <button onclick="setColor('#1a202c', this)" class="tool-btn" style="color:#1a202c"><i class="fas fa-circle"></i></button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('pizarra');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        
        let currentMode = '', history = [], isDrawing = false, points = [];
        let currentTool = 'free', currentColor = '#00E5FF', snapshot, isMagicOn = false;

        function initApp(mode) {
            currentMode = mode;
            document.getElementById('modeOverlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            if(mode === 'paper') container.classList.add('notebook-style');
            else document.getElementById('cameraInput').click();
            setTimeout(resizeCanvas, 100);
        }

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 3;
            if(history.length > 0) {
                let img = new Image(); img.src = history[history.length-1];
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        function cargarImagen(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        const ratio = Math.min(canvas.width/img.width, canvas.height/img.height);
                        ctx.drawImage(img, (canvas.width-img.width*ratio)/2, (canvas.height-img.height*ratio)/2, img.width*ratio, img.height*ratio);
                        saveState();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - r.left, y: cy - r.top };
        }

        canvas.addEventListener('touchstart', (e) => {
            const pos = getPos(e);
            if(currentTool === 'text') { insertarTexto(pos.x, pos.y); return; }
            isDrawing = true; points = [pos];
            snapshot = ctx.getImageData(0,0,canvas.width,canvas.height);
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            if(currentTool === 'eraser') {
                ctx.globalCompositeOperation = (currentMode === 'paper') ? 'destination-out' : 'source-over';
                ctx.strokeStyle = (currentMode === 'paper') ? 'rgba(0,0,0,1)' : '#ffffff';
                ctx.lineWidth = 30;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor; ctx.lineWidth = 3;
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            if(!isDrawing) return; e.preventDefault();
            const pos = getPos(e);
            if(currentTool !== 'free' && currentTool !== 'eraser') ctx.putImageData(snapshot, 0, 0);
            
            if(currentTool === 'free' || currentTool === 'eraser') {
                ctx.lineTo(pos.x, pos.y); ctx.stroke(); points.push(pos);
            } else if(currentTool === 'rect') {
                ctx.strokeRect(points[0].x, points[0].y, pos.x-points[0].x, pos.y-points[0].y);
            } else if(currentTool === 'circle') {
                const r = Math.sqrt(Math.pow(pos.x-points[0].x,2)+Math.pow(pos.y-points[0].y,2));
                ctx.beginPath(); ctx.arc(points[0].x, points[0].y, r, 0, Math.PI*2); ctx.stroke();
            } else if(currentTool === 'arc') {
                const midX = (points[0].x + pos.x)/2; const midY = (points[0].y + pos.y)/2;
                const dist = Math.sqrt(Math.pow(pos.x-points[0].x,2)+Math.pow(pos.y-points[0].y,2));
                ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
                ctx.quadraticCurveTo(midX, midY - dist/2, pos.x, pos.y); ctx.stroke();
            }
        });

        canvas.addEventListener('touchend', () => {
            if(!isDrawing) return; isDrawing = false;
            if(currentTool === 'free' && isMagicOn && points.length > 5) {
                ctx.putImageData(snapshot, 0, 0);
                ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
                ctx.lineTo(points[points.length-1].x, points[points.length-1].y); ctx.stroke();
            }
            ctx.globalCompositeOperation = 'source-over';
            saveState();
        });

        async function insertarTexto(x, y) {
            const { value: t } = await Swal.fire({ title: 'Medida', input: 'text' });
            if(t) { ctx.font = "20px Patrick Hand"; ctx.fillStyle = currentColor; ctx.fillText(t, x, y); saveState(); }
        }

        function setTool(t, btn) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setColor(c, btn) {
            currentColor = c;
            if(currentTool === 'eraser') setTool('free', document.querySelector('.tool-btn:nth-child(3)'));
        }

        function toggleMagic() { isMagicOn = !isMagicOn; document.getElementById('btnMagic').classList.toggle('magic-active'); }
        function saveState() { history.push(canvas.toDataURL()); if(history.length > 15) history.shift(); }
        function deshacer() { if(history.length > 1) { history.pop(); let img = new Image(); img.src = history[history.length-1]; img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); } } }
        function borrarLienzoSmart() { ctx.clearRect(0,0,canvas.width,canvas.height); history = []; }
        function generarPDFTaller() { const doc = new jsPDF(); doc.text("HERRERIA CELIS", 10, 10); doc.addImage(canvas.toDataURL(), 'PNG', 10, 20, 180, 120); doc.save('Celis.pdf'); }
    </script>
</body>
</html>
